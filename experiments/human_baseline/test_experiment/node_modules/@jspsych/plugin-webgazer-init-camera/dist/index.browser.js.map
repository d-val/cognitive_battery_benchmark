{"version":3,"file":"index.browser.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nconst info = <const>{\n  name: \"webgazer-init-camera\",\n  parameters: {\n    /** Instruction text */\n    instructions: {\n      type: ParameterType.HTML_STRING,\n      default: `\n            <p>Position your head so that the webcam has a good view of your eyes.</p>\n            <p>Center your face in the box and look directly towards the camera.</p>\n            <p>It is important that you try and keep your head reasonably still throughout the experiment, so please take a moment to adjust your setup to be comfortable.</p>\n            <p>When your face is centered in the box and the box is green, you can click to continue.</p>`,\n    },\n    /** Text for the button that participants click to end the trial. */\n    button_text: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * **webgazer-init-camera**\n *\n * jsPsych plugin for initializing the webcam and helping the participant center their face in the camera view.\n * Intended for use with the WebGazer eye-tracking extension.\n *\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/plugins/jspsych-webgazer-init-camera/ webgazer-init-camera plugin} and\n * {@link https://www.jspsych.org/overview/eye-tracking/ eye-tracking overview} documentation on jspsych.org\n */\nclass WebgazerInitCameraPlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>, on_load: () => void) {\n    let trial_complete;\n\n    var start_time = performance.now();\n    var load_time: number;\n\n    // function to end trial when it is time\n    const end_trial = () => {\n      this.jsPsych.extensions[\"webgazer\"].pause();\n      this.jsPsych.extensions[\"webgazer\"].hideVideo();\n\n      // kill any remaining setTimeout handlers\n      this.jsPsych.pluginAPI.clearAllTimeouts();\n\n      // gather the data to store for the trial\n      var trial_data = {\n        load_time: load_time,\n      };\n\n      // clear the display\n      display_element.innerHTML = \"\";\n\n      document.querySelector(\"#webgazer-center-style\").remove();\n\n      // move on to the next trial\n      this.jsPsych.finishTrial(trial_data);\n\n      trial_complete();\n    };\n\n    const showTrial = () => {\n      on_load();\n\n      load_time = Math.round(performance.now() - start_time);\n\n      var style = `\n          <style id=\"webgazer-center-style\">\n            #webgazerVideoContainer { top: 20px !important; left: calc(50% - 160px) !important;}\n          </style>\n        `;\n      document.querySelector(\"head\").insertAdjacentHTML(\"beforeend\", style);\n\n      var html = `\n          <div id='webgazer-init-container' style='position: relative; width:100vw; height:100vh'>\n          </div>`;\n\n      display_element.innerHTML = html;\n\n      this.jsPsych.extensions[\"webgazer\"].showVideo();\n      this.jsPsych.extensions[\"webgazer\"].resume();\n\n      var wg_container = display_element.querySelector(\"#webgazer-init-container\");\n\n      wg_container.innerHTML = `\n          <div style='position: absolute; top: max(260px, 40%); left: calc(50% - 400px); width:800px;'>\n          ${trial.instructions}\n          <button id='jspsych-wg-cont' class='jspsych-btn' disabled>${trial.button_text}</button>\n          </div>`;\n\n      if (is_face_detect_green()) {\n        (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\n      } else {\n        var observer = new MutationObserver(face_detect_event_observer);\n        observer.observe(document, {\n          attributes: true,\n          attributeFilter: [\"style\"],\n          subtree: true,\n        });\n      }\n\n      document.querySelector(\"#jspsych-wg-cont\").addEventListener(\"click\", () => {\n        if (observer) {\n          observer.disconnect();\n        }\n        end_trial();\n      });\n    };\n\n    if (!this.jsPsych.extensions.webgazer.isInitialized()) {\n      this.jsPsych.extensions.webgazer\n        .start()\n        .then(() => {\n          showTrial();\n        })\n        .catch((error) => {\n          console.log(error);\n          display_element.innerHTML = `<p>The experiment cannot continue because the eye tracker failed to start.</p>\n              <p>This may be because of a technical problem or because you did not grant permission for the page to use your camera.</p>`;\n        });\n    } else {\n      showTrial();\n    }\n\n    function is_face_detect_green() {\n      if (document.querySelector(\"#webgazerFaceFeedbackBox\")) {\n        return (\n          (document.querySelector(\"#webgazerFaceFeedbackBox\") as HTMLElement).style.borderColor ==\n          \"green\"\n        );\n      } else {\n        return false;\n      }\n    }\n\n    function face_detect_event_observer(mutationsList, observer) {\n      if (mutationsList[0].target == document.querySelector(\"#webgazerFaceFeedbackBox\")) {\n        if (\n          mutationsList[0].type == \"attributes\" &&\n          mutationsList[0].target.style.borderColor == \"green\"\n        ) {\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\n        }\n        if (\n          mutationsList[0].type == \"attributes\" &&\n          mutationsList[0].target.style.borderColor == \"red\"\n        ) {\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = true;\n        }\n      }\n    }\n\n    return new Promise((resolve) => {\n      trial_complete = resolve;\n    });\n  }\n}\n\nexport default WebgazerInitCameraPlugin;\n"],"names":["ParameterType"],"mappings":"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"}