{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nconst info = <const>{\n  name: \"webgazer-init-camera\",\n  parameters: {\n    /** Instruction text */\n    instructions: {\n      type: ParameterType.HTML_STRING,\n      default: `\n            <p>Position your head so that the webcam has a good view of your eyes.</p>\n            <p>Center your face in the box and look directly towards the camera.</p>\n            <p>It is important that you try and keep your head reasonably still throughout the experiment, so please take a moment to adjust your setup to be comfortable.</p>\n            <p>When your face is centered in the box and the box is green, you can click to continue.</p>`,\n    },\n    /** Text for the button that participants click to end the trial. */\n    button_text: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * **webgazer-init-camera**\n *\n * jsPsych plugin for initializing the webcam and helping the participant center their face in the camera view.\n * Intended for use with the WebGazer eye-tracking extension.\n *\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/plugins/jspsych-webgazer-init-camera/ webgazer-init-camera plugin} and\n * {@link https://www.jspsych.org/overview/eye-tracking/ eye-tracking overview} documentation on jspsych.org\n */\nclass WebgazerInitCameraPlugin implements JsPsychPlugin<Info> {\n  static info = info;\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>, on_load: () => void) {\n    let trial_complete;\n\n    var start_time = performance.now();\n    var load_time: number;\n\n    // function to end trial when it is time\n    const end_trial = () => {\n      this.jsPsych.extensions[\"webgazer\"].pause();\n      this.jsPsych.extensions[\"webgazer\"].hideVideo();\n\n      // kill any remaining setTimeout handlers\n      this.jsPsych.pluginAPI.clearAllTimeouts();\n\n      // gather the data to store for the trial\n      var trial_data = {\n        load_time: load_time,\n      };\n\n      // clear the display\n      display_element.innerHTML = \"\";\n\n      document.querySelector(\"#webgazer-center-style\").remove();\n\n      // move on to the next trial\n      this.jsPsych.finishTrial(trial_data);\n\n      trial_complete();\n    };\n\n    const showTrial = () => {\n      on_load();\n\n      load_time = Math.round(performance.now() - start_time);\n\n      var style = `\n          <style id=\"webgazer-center-style\">\n            #webgazerVideoContainer { top: 20px !important; left: calc(50% - 160px) !important;}\n          </style>\n        `;\n      document.querySelector(\"head\").insertAdjacentHTML(\"beforeend\", style);\n\n      var html = `\n          <div id='webgazer-init-container' style='position: relative; width:100vw; height:100vh'>\n          </div>`;\n\n      display_element.innerHTML = html;\n\n      this.jsPsych.extensions[\"webgazer\"].showVideo();\n      this.jsPsych.extensions[\"webgazer\"].resume();\n\n      var wg_container = display_element.querySelector(\"#webgazer-init-container\");\n\n      wg_container.innerHTML = `\n          <div style='position: absolute; top: max(260px, 40%); left: calc(50% - 400px); width:800px;'>\n          ${trial.instructions}\n          <button id='jspsych-wg-cont' class='jspsych-btn' disabled>${trial.button_text}</button>\n          </div>`;\n\n      if (is_face_detect_green()) {\n        (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\n      } else {\n        var observer = new MutationObserver(face_detect_event_observer);\n        observer.observe(document, {\n          attributes: true,\n          attributeFilter: [\"style\"],\n          subtree: true,\n        });\n      }\n\n      document.querySelector(\"#jspsych-wg-cont\").addEventListener(\"click\", () => {\n        if (observer) {\n          observer.disconnect();\n        }\n        end_trial();\n      });\n    };\n\n    if (!this.jsPsych.extensions.webgazer.isInitialized()) {\n      this.jsPsych.extensions.webgazer\n        .start()\n        .then(() => {\n          showTrial();\n        })\n        .catch((error) => {\n          console.log(error);\n          display_element.innerHTML = `<p>The experiment cannot continue because the eye tracker failed to start.</p>\n              <p>This may be because of a technical problem or because you did not grant permission for the page to use your camera.</p>`;\n        });\n    } else {\n      showTrial();\n    }\n\n    function is_face_detect_green() {\n      if (document.querySelector(\"#webgazerFaceFeedbackBox\")) {\n        return (\n          (document.querySelector(\"#webgazerFaceFeedbackBox\") as HTMLElement).style.borderColor ==\n          \"green\"\n        );\n      } else {\n        return false;\n      }\n    }\n\n    function face_detect_event_observer(mutationsList, observer) {\n      if (mutationsList[0].target == document.querySelector(\"#webgazerFaceFeedbackBox\")) {\n        if (\n          mutationsList[0].type == \"attributes\" &&\n          mutationsList[0].target.style.borderColor == \"green\"\n        ) {\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = false;\n        }\n        if (\n          mutationsList[0].type == \"attributes\" &&\n          mutationsList[0].target.style.borderColor == \"red\"\n        ) {\n          (document.querySelector(\"#jspsych-wg-cont\") as HTMLButtonElement).disabled = true;\n        }\n      }\n    }\n\n    return new Promise((resolve) => {\n      trial_complete = resolve;\n    });\n  }\n}\n\nexport default WebgazerInitCameraPlugin;\n"],"names":[],"mappings":";;AAEA,MAAM,IAAI,GAAU;AAClB,IAAA,IAAI,EAAE,sBAAsB;AAC5B,IAAA,UAAU,EAAE;;AAEV,QAAA,YAAY,EAAE;YACZ,IAAI,EAAE,aAAa,CAAC,WAAW;AAC/B,YAAA,OAAO,EAAE,CAAA;;;;AAI2F,yGAAA,CAAA;AACrG,SAAA;;AAED,QAAA,WAAW,EAAE;YACX,IAAI,EAAE,aAAa,CAAC,MAAM;AAC1B,YAAA,OAAO,EAAE,UAAU;AACpB,SAAA;AACF,KAAA;CACF,CAAC;AAIF;;;;;;;;;AASG;AACH,MAAM,wBAAwB,CAAA;AAG5B,IAAA,WAAA,CAAoB,OAAgB,EAAA;QAAhB,IAAO,CAAA,OAAA,GAAP,OAAO,CAAS;KAAI;AAExC,IAAA,KAAK,CAAC,eAA4B,EAAE,KAAsB,EAAE,OAAmB,EAAA;AAC7E,QAAA,IAAI,cAAc,CAAC;AAEnB,QAAA,IAAI,UAAU,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;AACnC,QAAA,IAAI,SAAiB,CAAC;;QAGtB,MAAM,SAAS,GAAG,MAAK;YACrB,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,KAAK,EAAE,CAAC;YAC5C,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,SAAS,EAAE,CAAC;;AAGhD,YAAA,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,gBAAgB,EAAE,CAAC;;AAG1C,YAAA,IAAI,UAAU,GAAG;AACf,gBAAA,SAAS,EAAE,SAAS;aACrB,CAAC;;AAGF,YAAA,eAAe,CAAC,SAAS,GAAG,EAAE,CAAC;YAE/B,QAAQ,CAAC,aAAa,CAAC,wBAAwB,CAAC,CAAC,MAAM,EAAE,CAAC;;AAG1D,YAAA,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,UAAU,CAAC,CAAC;AAErC,YAAA,cAAc,EAAE,CAAC;AACnB,SAAC,CAAC;QAEF,MAAM,SAAS,GAAG,MAAK;AACrB,YAAA,OAAO,EAAE,CAAC;AAEV,YAAA,SAAS,GAAG,IAAI,CAAC,KAAK,CAAC,WAAW,CAAC,GAAG,EAAE,GAAG,UAAU,CAAC,CAAC;AAEvD,YAAA,IAAI,KAAK,GAAG,CAAA;;;;SAIT,CAAC;AACJ,YAAA,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC,kBAAkB,CAAC,WAAW,EAAE,KAAK,CAAC,CAAC;AAEtE,YAAA,IAAI,IAAI,GAAG,CAAA;;iBAEA,CAAC;AAEZ,YAAA,eAAe,CAAC,SAAS,GAAG,IAAI,CAAC;YAEjC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,SAAS,EAAE,CAAC;YAChD,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,UAAU,CAAC,CAAC,MAAM,EAAE,CAAC;YAE7C,IAAI,YAAY,GAAG,eAAe,CAAC,aAAa,CAAC,0BAA0B,CAAC,CAAC;YAE7E,YAAY,CAAC,SAAS,GAAG,CAAA;;AAEnB,UAAA,EAAA,KAAK,CAAC,YAAY,CAAA;AACwC,oEAAA,EAAA,KAAK,CAAC,WAAW,CAAA;iBACtE,CAAC;YAEZ,IAAI,oBAAoB,EAAE,EAAE;gBACzB,QAAQ,CAAC,aAAa,CAAC,kBAAkB,CAAuB,CAAC,QAAQ,GAAG,KAAK,CAAC;AACpF,aAAA;AAAM,iBAAA;AACL,gBAAA,IAAI,QAAQ,GAAG,IAAI,gBAAgB,CAAC,0BAA0B,CAAC,CAAC;AAChE,gBAAA,QAAQ,CAAC,OAAO,CAAC,QAAQ,EAAE;AACzB,oBAAA,UAAU,EAAE,IAAI;oBAChB,eAAe,EAAE,CAAC,OAAO,CAAC;AAC1B,oBAAA,OAAO,EAAE,IAAI;AACd,iBAAA,CAAC,CAAC;AACJ,aAAA;YAED,QAAQ,CAAC,aAAa,CAAC,kBAAkB,CAAC,CAAC,gBAAgB,CAAC,OAAO,EAAE,MAAK;AACxE,gBAAA,IAAI,QAAQ,EAAE;oBACZ,QAAQ,CAAC,UAAU,EAAE,CAAC;AACvB,iBAAA;AACD,gBAAA,SAAS,EAAE,CAAC;AACd,aAAC,CAAC,CAAC;AACL,SAAC,CAAC;QAEF,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,QAAQ,CAAC,aAAa,EAAE,EAAE;AACrD,YAAA,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,QAAQ;AAC7B,iBAAA,KAAK,EAAE;iBACP,IAAI,CAAC,MAAK;AACT,gBAAA,SAAS,EAAE,CAAC;AACd,aAAC,CAAC;AACD,iBAAA,KAAK,CAAC,CAAC,KAAK,KAAI;AACf,gBAAA,OAAO,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;gBACnB,eAAe,CAAC,SAAS,GAAG,CAAA;yIACmG,CAAC;AAClI,aAAC,CAAC,CAAC;AACN,SAAA;AAAM,aAAA;AACL,YAAA,SAAS,EAAE,CAAC;AACb,SAAA;AAED,QAAA,SAAS,oBAAoB,GAAA;AAC3B,YAAA,IAAI,QAAQ,CAAC,aAAa,CAAC,0BAA0B,CAAC,EAAE;gBACtD,QACG,QAAQ,CAAC,aAAa,CAAC,0BAA0B,CAAiB,CAAC,KAAK,CAAC,WAAW;AACrF,oBAAA,OAAO,EACP;AACH,aAAA;AAAM,iBAAA;AACL,gBAAA,OAAO,KAAK,CAAC;AACd,aAAA;SACF;AAED,QAAA,SAAS,0BAA0B,CAAC,aAAa,EAAE,QAAQ,EAAA;AACzD,YAAA,IAAI,aAAa,CAAC,CAAC,CAAC,CAAC,MAAM,IAAI,QAAQ,CAAC,aAAa,CAAC,0BAA0B,CAAC,EAAE;AACjF,gBAAA,IACE,aAAa,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,YAAY;oBACrC,aAAa,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,WAAW,IAAI,OAAO,EACpD;oBACC,QAAQ,CAAC,aAAa,CAAC,kBAAkB,CAAuB,CAAC,QAAQ,GAAG,KAAK,CAAC;AACpF,iBAAA;AACD,gBAAA,IACE,aAAa,CAAC,CAAC,CAAC,CAAC,IAAI,IAAI,YAAY;oBACrC,aAAa,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,WAAW,IAAI,KAAK,EAClD;oBACC,QAAQ,CAAC,aAAa,CAAC,kBAAkB,CAAuB,CAAC,QAAQ,GAAG,IAAI,CAAC;AACnF,iBAAA;AACF,aAAA;SACF;AAED,QAAA,OAAO,IAAI,OAAO,CAAC,CAAC,OAAO,KAAI;YAC7B,cAAc,GAAG,OAAO,CAAC;AAC3B,SAAC,CAAC,CAAC;KACJ;;AAhIM,wBAAI,CAAA,IAAA,GAAG,IAAI;;;;"}